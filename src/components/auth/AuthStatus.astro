---
// è®¤è¯çŠ¶æ€ç»„ä»¶ - æ ¹æ®ç”¨æˆ·ç™»å½•çŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹
import GoogleSignInButton from './GoogleSignInButton.astro';

// ä¸åœ¨æœåŠ¡ç«¯è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ”¹ä¸ºåœ¨å®¢æˆ·ç«¯å¤„ç†
// const user = null;
---

<script>
  // å¯¼å…¥Supabaseå®¢æˆ·ç«¯
  import { supabase } from '/src/lib/supabase.ts';
  
  // å°†supabaseå®ä¾‹æŒ‚è½½åˆ°windowå¯¹è±¡ï¼Œä¾›Alpine.jsä½¿ç”¨
  window.supabaseClient = supabase;
</script>

<div id="auth-status" class="flex items-center space-x-4" x-data="{ 
  user: null,
  isOpen: false,
  loading: true,
  authError: null,
  authSubscription: null,
  
  async init() {
    console.log('AuthStatus ç»„ä»¶åˆå§‹åŒ–å¼€å§‹');
    this.loading = true;
    
    try {
      // é¦–å…ˆå°è¯•ä»cookieè¯»å–ç”¨æˆ·ä¿¡æ¯
      await this.loadUserFromCookie();
      
      // ç„¶ååŠ è½½å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
      await this.loadUser();
      this.setupAuthListener();
      
      console.log('AuthStatus ç»„ä»¶åˆå§‹åŒ–å®Œæˆï¼Œç”¨æˆ·çŠ¶æ€:', this.user ? 'å·²ç™»å½•' : 'æœªç™»å½•');
    } catch (error) {
      console.error('AuthStatus åˆå§‹åŒ–å¤±è´¥:', error);
      this.authError = 'è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥';
    } finally {
      this.loading = false;
    }
  },
  
  // ä»cookieåŠ è½½ç”¨æˆ·ä¿¡æ¯
  loadUserFromCookie() {
    console.log('ğŸª å¼€å§‹ä»cookieåŠ è½½ç”¨æˆ·ä¿¡æ¯');
    console.log('ğŸª å½“å‰æ‰€æœ‰cookies:', document.cookie);
    
    try {
      // é¦–å…ˆå°è¯•ä»session cookieåŠ è½½
      const sessionCookie = document.cookie
        .split('; ')
        .find(row => row.startsWith('session='));
      
      if (sessionCookie) {
        console.log('ğŸª æ‰¾åˆ°session cookie');
        const sessionStr = decodeURIComponent(sessionCookie.split('=')[1]);
        console.log('ğŸª è§£ç åçš„session:', sessionStr);
        const sessionInfo = JSON.parse(sessionStr);
        
        // æ„é€ ç”¨æˆ·å¯¹è±¡ï¼Œæ¨¡æ‹ŸSupabaseç”¨æˆ·æ ¼å¼
        this.user = {
          id: sessionInfo.userId,
          email: sessionInfo.email,
          user_metadata: {
            full_name: sessionInfo.name,
            name: sessionInfo.name,
            picture: sessionInfo.avatar_url,
            avatar_url: sessionInfo.avatar_url
          },
          avatar_url: sessionInfo.avatar_url,
          role: sessionInfo.role
        };
        
        console.log('âœ… ä»session cookieåŠ è½½ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:', this.user);
        return true;
      }
      
      // å¦‚æœæ²¡æœ‰session cookieï¼Œå°è¯•user_info cookie
      const userInfoCookie = document.cookie
        .split('; ')
        .find(row => row.startsWith('user_info='));
      
      if (userInfoCookie) {
        console.log('ğŸª æ‰¾åˆ°user_info cookie');
        const userInfoStr = decodeURIComponent(userInfoCookie.split('=')[1]);
        console.log('ğŸª è§£ç åçš„user_info:', userInfoStr);
        const userInfo = JSON.parse(userInfoStr);
        
        // æ„é€ ç”¨æˆ·å¯¹è±¡ï¼Œæ¨¡æ‹ŸSupabaseç”¨æˆ·æ ¼å¼
        this.user = {
          id: userInfo.id,
          email: userInfo.email,
          user_metadata: {
            full_name: userInfo.name,
            name: userInfo.name,
            picture: userInfo.avatar_url,
            avatar_url: userInfo.avatar_url
          },
          avatar_url: userInfo.avatar_url,
          role: userInfo.role
        };
        
        console.log('âœ… ä»user_info cookieåŠ è½½ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:', this.user);
        return true;
      }
      
      console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç”¨æˆ·cookie');
    } catch (error) {
      console.error('âŒ ä»cookieåŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
    return false;
  },
  
  get userName() {
    if (!this.user) return 'ç”¨æˆ·';
    return this.user.user_metadata?.full_name || 
           this.user.user_metadata?.name || 
           this.user.email?.split('@')[0] || 
           'ç”¨æˆ·';
  },
  
  // åˆ¤æ–­æ˜¯å¦ä¸ºç®¡ç†å‘˜
  get isAdmin() {
    if (!this.user?.email) return false;
    
    // ç®¡ç†å‘˜é‚®ç®±åˆ—è¡¨ï¼ˆå¯ä»¥ä»ç¯å¢ƒå˜é‡è·å–ï¼‰
    const adminEmails = [
      'admin@example.com',
      'wangdefou@gmail.com', // ç¤ºä¾‹ç®¡ç†å‘˜é‚®ç®±
      'wangpangzier@gmail.com', // ä¸»è¦ç®¡ç†å‘˜é‚®ç®±
      // å¯ä»¥æ·»åŠ æ›´å¤šç®¡ç†å‘˜é‚®ç®±
    ];
    
    // æ£€æŸ¥æ˜¯å¦åœ¨ç®¡ç†å‘˜é‚®ç®±åˆ—è¡¨ä¸­
    if (adminEmails.includes(this.user.email.toLowerCase())) {
      return true;
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹å®šåŸŸåï¼ˆå¯é€‰ï¼‰
    const adminDomains = [
      '@yourdomain.com', // ç¤ºä¾‹å…¬å¸åŸŸå
      // å¯ä»¥æ·»åŠ æ›´å¤šç®¡ç†å‘˜åŸŸå
    ];
    
    return adminDomains.some(domain => 
      this.user.email.toLowerCase().endsWith(domain)
    );
  },
  
  // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€
  toggleDropdown() {
    console.log('toggleDropdown è¢«è°ƒç”¨ï¼Œå½“å‰ isOpen:', this.isOpen);
    this.isOpen = !this.isOpen;
    console.log('toggleDropdown æ‰§è¡Œåï¼Œæ–°çš„ isOpen:', this.isOpen);
  },
  
  // ä»SupabaseåŠ è½½ç”¨æˆ·ä¿¡æ¯
  async loadUser() {
    console.log('å¼€å§‹åŠ è½½ç”¨æˆ·ä¿¡æ¯');
    
    try {
      const supabase = window.supabaseClient;
      
      // è·å–å½“å‰ä¼šè¯
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('è·å–ä¼šè¯å¤±è´¥:', sessionError);
        this.authError = 'è·å–ä¼šè¯å¤±è´¥';
        return;
      }
      
      if (!session?.user) {
        console.log('æ²¡æœ‰æ´»è·ƒä¼šè¯ï¼Œç”¨æˆ·æœªç™»å½•');
        // å¦‚æœå·²ç»ä»cookieåŠ è½½äº†ç”¨æˆ·ä¿¡æ¯ï¼Œå°±ä¸è¦æ¸…é™¤
        if (!this.user) {
          this.user = null;
        }
        console.log('ç”¨æˆ·åŠ è½½å®Œæˆï¼Œç”¨æˆ·çŠ¶æ€:', this.user ? 'å·²ç™»å½•' : 'æœªç™»å½•');
        return;
      }
      
      // å¦‚æœå·²ç»ä»cookieåŠ è½½äº†ç”¨æˆ·ä¿¡æ¯ï¼Œå°±ä¸éœ€è¦é‡æ–°è®¾ç½®
      if (!this.user) {
        console.log('ä»Supabaseä¼šè¯è·å–ç”¨æˆ·ä¿¡æ¯');
        
        try {
          // å°è¯•ä»æ•°æ®åº“è·å–æ›´å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
          const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', session.user.id)
            .single();
          
          if (userError && userError.code !== 'PGRST116') {
            console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', userError);
          }
          
          // åˆå¹¶Supabase Authç”¨æˆ·ä¿¡æ¯å’Œæ•°æ®åº“ç”¨æˆ·ä¿¡æ¯
          this.user = {
            ...session.user,
            ...userData,
            user_metadata: {
              ...session.user.user_metadata,
              ...userData?.user_metadata
            }
          };
          
          console.log('ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ:', this.user);
        } catch (dbError) {
          console.error('æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸:', dbError);
          // å¦‚æœæ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œè‡³å°‘ä½¿ç”¨Authç”¨æˆ·ä¿¡æ¯
          this.user = session.user;
        }
      }
      
      console.log('ç”¨æˆ·åŠ è½½å®Œæˆï¼Œç”¨æˆ·çŠ¶æ€:', this.user ? 'å·²ç™»å½•' : 'æœªç™»å½•');
      
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
      this.authError = 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥';
    }
  },
  
  // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨
  setupAuthListener() {
    console.log('è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨');
    
    try {
      const supabase = window.supabaseClient;
      this.authSubscription = supabase.auth.onAuthStateChange((event, session) => {
        console.log('Auth state changed:', event, session?.user ? 'user logged in' : 'no user');
        
        if (event === 'INITIAL_SESSION') {
          console.log('åˆå§‹ä¼šè¯');
          // åˆå§‹ä¼šè¯å·²ç»åœ¨loadUserä¸­å¤„ç†
          return;
        }
        
        if (event === 'SIGNED_IN') {
          console.log('ç”¨æˆ·ç™»å½•');
          this.loadUser();
        } else if (event === 'SIGNED_OUT') {
          console.log('ç”¨æˆ·ç™»å‡º');
          this.user = null;
          this.isOpen = false;
        } else if (event === 'TOKEN_REFRESHED') {
          console.log('Tokenå·²åˆ·æ–°');
          // Tokenåˆ·æ–°æ—¶é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
          this.loadUser();
        }
      });
    } catch (error) {
      console.error('è®¾ç½®è®¤è¯ç›‘å¬å™¨å¤±è´¥:', error);
    }
  },
  
  // å¤„ç†ç™»å‡º
  async handleLogout() {
    try {
      console.log('ğŸšª å¼€å§‹ç™»å‡ºæµç¨‹...');
      
      // è°ƒç”¨æœåŠ¡ç«¯ç™»å‡ºAPI - ä½¿ç”¨æ­£ç¡®çš„ç«¯å£
      const apiUrl = window.location.origin + '/api/auth/logout';
      console.log('ğŸšª ç™»å‡ºAPI URL:', apiUrl);
      
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      });
      
      console.log('ğŸšª ç™»å‡ºAPIå“åº”çŠ¶æ€:', response.status);
      
      if (response.ok) {
        const result = await response.json();
        console.log('ğŸšª ç™»å‡ºAPIå“åº”:', result);
      } else {
        console.warn('ğŸšª ç™»å‡ºAPIå¤±è´¥ï¼Œä½†ç»§ç»­æ¸…é™¤æœ¬åœ°çŠ¶æ€:', response.status, response.statusText);
      }
    } catch (error) {
      console.warn('ğŸšª ç™»å‡ºAPIè°ƒç”¨å¤±è´¥ï¼Œä½†ç»§ç»­æ¸…é™¤æœ¬åœ°çŠ¶æ€:', error);
    }
    
    // æ— è®ºAPIè°ƒç”¨æ˜¯å¦æˆåŠŸï¼Œéƒ½è¦æ¸…é™¤æœ¬åœ°çŠ¶æ€
    try {
      console.log('ğŸ§¹ æ¸…é™¤æœ¬åœ°å­˜å‚¨å’Œcookies...');
      
      // æ¸…é™¤æœ¬åœ°å­˜å‚¨
      if (typeof window !== 'undefined') {
        localStorage.clear();
        sessionStorage.clear();
        
        // æ¸…é™¤æ‰€æœ‰ç›¸å…³cookieï¼Œä½¿ç”¨ä¸€è‡´çš„domainé…ç½®
        const cookiesToClear = [
          'sb-access-token',
          'sb-refresh-token', 
          'supabase-auth-token',
          'supabase.auth.token',
          'user_info',
          'session',
          'oauth_state'
        ];
        
        // è·å–å½“å‰åŸŸå
        const currentUrl = window.location.href;
        const isProduction = currentUrl.startsWith('https') && !currentUrl.includes('localhost');
        let domain = '';
        
        if (isProduction) {
          try {
            const urlObj = new URL(currentUrl);
            domain = urlObj.hostname;
            domain = domain.startsWith('www.') ? domain.substring(4) : domain;
          } catch (e) {
            console.warn('æ— æ³•è§£æå½“å‰URLï¼Œä½¿ç”¨é»˜è®¤domainè®¾ç½®:', e);
          }
        }
        
        cookiesToClear.forEach(cookieName => {
          // æ¸…é™¤ä¸åŒåŸŸå’Œè·¯å¾„çš„cookie
          if (isProduction && domain) {
            // ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨æ­£ç¡®çš„domain
            document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${domain}`;
            document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.${domain}`;
          } else {
            // æœ¬åœ°ç¯å¢ƒï¼šä½¿ç”¨localhost
            document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=localhost`;
            document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.localhost`;
          }
          // é€šç”¨æ¸…é™¤ï¼ˆä¸æŒ‡å®šdomainï¼‰
          document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
        });
        
        console.log('âœ… å·²æ¸…é™¤Cookieï¼Œdomainé…ç½®:', { domain, isProduction });
        
        console.log('âœ… å·²æ¸…é™¤æœ¬åœ°å­˜å‚¨å’Œcookies');
      }
      
      // é‡ç½®ç”¨æˆ·çŠ¶æ€
      this.user = null;
      
      console.log('ğŸ”„ é‡å®šå‘åˆ°é¦–é¡µ...');
      // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œé‡å®šå‘åˆ°é¦–é¡µ
      window.location.href = '/';
    } catch (error) {
      console.error('âŒ æ¸…é™¤æœ¬åœ°çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯:', error);
      // å³ä½¿æ¸…é™¤å¤±è´¥ï¼Œä¹Ÿè¦å°è¯•é‡å®šå‘
      window.location.href = '/';
    }
  }
}" x-cloak x-init="console.log('AuthStatus Alpine ç»„ä»¶å·²åˆå§‹åŒ–', $data)">
  <!-- åŠ è½½çŠ¶æ€ -->
  <div x-show="loading" class="flex items-center space-x-2">
    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
    <span class="text-sm text-gray-600">åŠ è½½ä¸­...</span>
  </div>
  
  <!-- é»˜è®¤æ˜¾ç¤ºç™»å½•æŒ‰é’® -->
  <div x-show="!loading && !user">
    <GoogleSignInButton 
      redirectTo="/admin/backlinks"
      className="inline-flex items-center justify-center px-4 py-2 text-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 font-medium rounded-lg transition-all duration-200 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md"
      size="sm"
      variant="primary"
    />
  </div>
  
  <!-- ç™»å½•åæ˜¾ç¤ºç”¨æˆ·å¤´åƒ -->
  <div x-show="!loading && user" class="relative">
    <!-- ç”¨æˆ·å¤´åƒæŒ‰é’® -->
    <button
      @click="toggleDropdown()"
      @keydown.escape="isOpen = false"
      class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200 focus:outline-none"
      :aria-expanded="isOpen"
      aria-label="ç”¨æˆ·èœå•"
    >
      <!-- å¤´åƒ -->
      <template x-if="user?.user_metadata?.avatar_url || user?.user_metadata?.picture">
        <img
          :src="user.user_metadata?.avatar_url || user.user_metadata?.picture"
          :alt="userName"
          class="w-8 h-8 rounded-full object-cover border-2 border-gray-200"
          loading="lazy"
        />
      </template>
      
      <template x-if="!user?.user_metadata?.avatar_url && !user?.user_metadata?.picture">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-medium text-sm">
          <span x-text="userName.charAt(0).toUpperCase()"></span>
        </div>
      </template>
      
      <!-- ç”¨æˆ·å (åœ¨å¤§å±å¹•ä¸Šæ˜¾ç¤º) -->
      <span class="hidden md:block text-sm font-medium text-gray-700 max-w-24 truncate" x-text="userName"></span>
      
      <!-- ä¸‹æ‹‰ç®­å¤´ -->
      <svg
        class="w-4 h-4 text-gray-500 transition-transform duration-200"
        :class="{ 'rotate-180': isOpen }"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>

    <!-- ä¸‹æ‹‰èœå• -->
    <div
      x-show="isOpen"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-95"
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 scale-100"
      x-transition:leave-end="opacity-0 scale-95"
      @click.away="isOpen = false"
      class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-[60]"
      style="transform-origin: top right;"
      x-init="console.log('ä¸‹æ‹‰èœå•å…ƒç´ åˆå§‹åŒ–', { isOpen })"
    >
      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <div class="px-4 py-3 border-b border-gray-100">
        <div class="flex items-center space-x-3">
          <!-- å¤´åƒ -->
          <template x-if="user?.user_metadata?.avatar_url || user?.user_metadata?.picture">
            <img
              :src="user.user_metadata?.avatar_url || user.user_metadata?.picture"
              :alt="userName"
              class="w-10 h-10 rounded-full object-cover"
              loading="lazy"
            />
          </template>
          
          <template x-if="!user?.user_metadata?.avatar_url && !user?.user_metadata?.picture">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-medium">
              <span x-text="userName.charAt(0).toUpperCase()"></span>
            </div>
          </template>
          
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900 truncate" x-text="userName"></p>
            <p class="text-xs text-gray-500 truncate" x-text="user?.email" x-show="user?.email"></p>
          </div>
        </div>
      </div>

      <!-- èœå•é¡¹ -->
      <div class="py-1">
        <a
          :href="isAdmin ? '/admin/dashboard' : '/dashboard'"
          class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150"
        >
          <svg class="w-4 h-4 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          <span x-text="isAdmin ? 'ç®¡ç†é¢æ¿' : 'ç®¡ç†å‘˜ç™»å½•'"></span>
        </a>
        
        <hr class="my-1 border-gray-100">
        
        <button
          @click="console.log('é€€å‡ºç™»å½•æŒ‰é’®è¢«ç‚¹å‡»'); handleLogout()"
          class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors duration-150"
        >
          <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          é€€å‡ºç™»å½•
        </button>
      </div>
    </div>
  </div>
</div>