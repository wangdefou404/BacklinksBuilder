---
// OAuth回调处理页面
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="登录处理中...">
  <div class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="max-w-md w-full space-y-8 p-8">
      <div class="text-center">
        <!-- 加载动画 -->
        <div class="flex justify-center mb-6">
          <svg
            class="animate-spin h-12 w-12 text-blue-600"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </div>
        
        <h2 class="text-2xl font-bold text-gray-900 mb-2">
          正在处理登录...
        </h2>
        
        <p class="text-gray-600 mb-6">
          请稍候，我们正在验证您的身份信息
        </p>
        
        <!-- 状态消息 -->
        <div id="status-message" class="text-sm text-gray-500">
          正在连接到认证服务器...
        </div>
        
        <!-- 错误消息 -->
        <div id="error-message" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span id="error-text" class="text-red-800"></span>
          </div>
          <div class="mt-3">
            <button
              id="retry-btn"
              class="text-sm bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded transition-colors"
            >
              重试
            </button>
            <a
              href="/auth/login"
              class="text-sm text-red-600 hover:text-red-800 ml-3 underline"
            >
              返回登录页
            </a>
          </div>
        </div>
        
        <!-- 成功消息 -->
        <div id="success-message" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-green-800">登录成功！正在跳转...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../../lib/supabase';
  import { syncUserToDatabase } from '../../lib/auth';

  // 获取DOM元素
  const statusMessage = document.getElementById('status-message');
  const errorMessage = document.getElementById('error-message');
  const errorText = document.getElementById('error-text');
  const successMessage = document.getElementById('success-message');
  const retryBtn = document.getElementById('retry-btn');

  // 更新状态消息
  function updateStatus(message: string) {
    if (statusMessage) {
      statusMessage.textContent = message;
    }
  }

  // 显示错误消息
  function showError(message: string) {
    if (errorMessage && errorText) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
    }
    if (statusMessage) {
      statusMessage.classList.add('hidden');
    }
  }

  // 显示成功消息
  function showSuccess() {
    if (successMessage) {
      successMessage.classList.remove('hidden');
    }
    if (statusMessage) {
      statusMessage.classList.add('hidden');
    }
  }

  // 检查是否有支付意图
  function hasPaymentIntent() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('payment_intent') === 'true';
  }

  // 处理支付意图
  async function handlePaymentIntent() {
    try {
      updateStatus('正在处理支付请求...');
      
      // 从sessionStorage获取支付数据
      const paymentDataStr = sessionStorage.getItem('payment_data');
      if (!paymentDataStr) {
        throw new Error('支付信息已过期，请重新选择套餐');
      }
      
      const paymentData = JSON.parse(paymentDataStr);
      
      // 检查数据是否过期（30分钟）
      if (Date.now() - paymentData.timestamp > 30 * 60 * 1000) {
        sessionStorage.removeItem('payment_data');
        throw new Error('支付信息已过期，请重新选择套餐');
      }
      
      updateStatus('正在获取用户信息...');
      
      // 获取用户ID
      const authResponse = await fetch('/api/auth/check');
      if (!authResponse.ok) {
        throw new Error('用户认证失败');
      }
      
      const authData = await authResponse.json();
      if (!authData.authenticated || !authData.user?.id) {
        throw new Error('用户未登录');
      }
      
      updateStatus('正在创建支付会话...');
      
      // 创建支付会话
      const checkoutResponse = await fetch('/api/payment/create-checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          plan: paymentData.plan,
          billing_cycle: paymentData.billing_cycle,
          user_id: authData.user.id
        })
      });
      
      if (!checkoutResponse.ok) {
        const errorData = await checkoutResponse.json();
        throw new Error(errorData.error || '创建支付会话失败');
      }
      
      const checkoutData = await checkoutResponse.json();
      
      if (!checkoutData.url) {
        throw new Error('未获取到支付链接');
      }
      
      // 清除sessionStorage中的支付数据
      sessionStorage.removeItem('payment_data');
      
      updateStatus('正在跳转到支付页面...');
      
      // 跳转到Stripe支付页面
      window.location.href = checkoutData.url;
      
    } catch (error) {
      console.error('处理支付意图失败:', error);
      showError(error instanceof Error ? error.message : '支付处理失败，请重试');
    }
  }

  // 处理OAuth回调
  async function handleOAuthCallback() {
    try {
      updateStatus('正在验证登录状态...');
      console.log('开始处理OAuth回调...');
      console.log('当前URL:', window.location.href);
      console.log('URL参数:', Object.fromEntries(new URLSearchParams(window.location.search)));

      // 等待Supabase自动处理OAuth回调
      // 在PKCE流程中，Supabase会自动检测URL中的认证信息并设置session
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // 获取当前session
      console.log('正在获取Supabase session...');
      const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('获取会话失败:', sessionError);
        throw new Error(`认证失败: ${sessionError.message}`);
      }
      
      console.log('Session数据:', sessionData);

      const session = sessionData.session;
      const user = session?.user;
      
      if (!session || !user) {
        console.log('第一次尝试未找到session，等待更长时间...');
        // 再等待一段时间，让Supabase完成session设置
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // 再次尝试获取session
        const { data: retrySessionData, error: retryError } = await supabase.auth.getSession();
        
        if (retryError) {
          console.error('重试获取会话失败:', retryError);
          throw new Error(`认证失败: ${retryError.message}`);
        }
        
        const retrySession = retrySessionData.session;
        const retryUser = retrySession?.user;
        
        if (!retrySession || !retryUser) {
          throw new Error('未找到有效的登录会话，请重新登录');
        }
        
        // 使用重试获取的session
        console.log('重试后成功获取session:', retryUser.email);
      } else {
        console.log('成功获取session:', user.email);
      }
      
      // 获取最终的session数据
      const { data: finalSessionData } = await supabase.auth.getSession();
      const finalSession = finalSessionData.session;
      const finalUser = finalSession?.user;
      
      if (!finalSession || !finalUser) {
        throw new Error('无法获取最终的用户信息');
      }
      
      console.log('用户认证成功:', finalUser.email);

      // 同步用户数据到数据库
      updateStatus('正在同步用户数据...');
      console.log('开始同步用户数据:', {
        id: finalUser.id,
        email: finalUser.email,
        provider: finalUser.app_metadata?.provider
      });
      try {
        await syncUserToDatabase(finalUser);
        console.log('用户数据同步成功');
      } catch (syncError) {
        console.warn('用户数据同步失败，但登录成功:', syncError);
        console.warn('同步错误详情:', syncError);
        // 即使同步失败，也继续登录流程
      }

      updateStatus('登录成功，正在跳转...');
      showSuccess();

      // 检查是否有支付意图需要处理
      if (hasPaymentIntent()) {
        console.log('发现支付意图，处理支付流程...');
        await handlePaymentIntent();
        return;
      }

      // 检查重定向参数
      const urlParams = new URLSearchParams(window.location.search);
      const redirectTo = urlParams.get('redirect_to') || '/admin/backlinks';
      
      console.log('URL参数中的redirect_to:', urlParams.get('redirect_to'));
      console.log('最终重定向目标:', redirectTo);
      console.log('准备重定向到:', redirectTo);
      
      // 如果重定向到管理面板，设置localStorage状态以通过认证检查
      if (redirectTo === '/admin/backlinks' || redirectTo.startsWith('/admin/')) {
        console.log('设置管理员localStorage状态...');
        localStorage.setItem('adminLoggedIn', 'true');
        localStorage.setItem('adminUsername', finalUser.email || 'OAuth用户');
        localStorage.setItem('adminLoginTime', new Date().toISOString());
        console.log('管理员localStorage状态已设置:', {
          adminLoggedIn: localStorage.getItem('adminLoggedIn'),
          adminUsername: localStorage.getItem('adminUsername'),
          adminLoginTime: localStorage.getItem('adminLoginTime')
        });
      }
      
      // 跳转到目标页面
      console.log('即将跳转到:', redirectTo);
      setTimeout(() => {
        console.log('执行跳转到:', redirectTo);
        window.location.href = redirectTo;
      }, 500);

    } catch (error) {
      console.error('OAuth回调处理失败:', error);
      console.error('错误堆栈:', error instanceof Error ? error.stack : error);
      console.error('当前URL状态:', {
        href: window.location.href,
        search: window.location.search,
        hash: window.location.hash
      });
      showError(error instanceof Error ? error.message : '登录处理失败，请重试');
    }
  }

  // 重试按钮事件
  if (retryBtn) {
    retryBtn.addEventListener('click', () => {
      // 隐藏错误消息
      if (errorMessage) {
        errorMessage.classList.add('hidden');
      }
      if (statusMessage) {
        statusMessage.classList.remove('hidden');
      }
      
      // 重新处理回调
      handleOAuthCallback();
    });
  }

  // 页面加载时处理OAuth回调
  document.addEventListener('DOMContentLoaded', () => {
    console.log('=== OAuth回调页面加载 ===');
    console.log('完整URL:', window.location.href);
    
    // 检查URL中是否包含认证相关参数
    const urlParams = new URLSearchParams(window.location.search);
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    
    // 检查是否有OAuth相关参数（code用于PKCE流程，error用于错误处理）
    const hasAuthParams = urlParams.has('code') || urlParams.has('error') || hashParams.has('error');
    
    console.log('检查认证参数:', {
      search: Object.fromEntries(urlParams),
      fragment: Object.fromEntries(hashParams),
      hasAuthParams,
      userAgent: navigator.userAgent
    });
    
    if (hasAuthParams) {
      console.log('发现OAuth参数，开始处理回调...');
      
      // 检查是否有错误参数
      const error = urlParams.get('error') || hashParams.get('error');
      const errorDescription = urlParams.get('error_description') || hashParams.get('error_description');
      
      if (error) {
        console.error('OAuth错误:', error, errorDescription);
        console.error('完整错误信息:', {
          error,
          errorDescription,
          url: window.location.href
        });
        showError(`登录失败: ${errorDescription || error}`);
        return;
      }
      
      // 处理OAuth回调
      handleOAuthCallback();
    } else {
      console.log('未发现OAuth参数，检查现有session...');
      // 如果没有OAuth参数，检查是否已经登录
      supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
          console.log('发现现有session，直接跳转...');
          showSuccess();
          setTimeout(() => {
            const redirectTo = urlParams.get('redirect_to') || '/admin/backlinks';
            console.log('现有session跳转到:', redirectTo);
            
            // 如果重定向到管理面板，设置localStorage状态以通过认证检查
            if (redirectTo === '/admin/backlinks' || redirectTo.startsWith('/admin/')) {
              console.log('为现有session设置管理员localStorage状态...');
              localStorage.setItem('adminLoggedIn', 'true');
              localStorage.setItem('adminUsername', session.user?.email || 'OAuth用户');
              localStorage.setItem('adminLoginTime', new Date().toISOString());
              console.log('现有session管理员localStorage状态已设置');
            }
            
            window.location.href = redirectTo;
          }, 500);
        } else {
          console.log('未找到现有session');
          showError('未找到有效的登录信息，请重新登录');
        }
      });
    }
  });
</script>