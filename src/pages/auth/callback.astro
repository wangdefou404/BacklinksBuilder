---
// OAuthå›è°ƒå¤„ç†é¡µé¢
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="ç™»å½•å¤„ç†ä¸­...">
  <div class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="max-w-md w-full space-y-8 p-8">
      <div class="text-center">
        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="flex justify-center mb-6">
          <svg
            class="animate-spin h-12 w-12 text-blue-600"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </div>
        
        <h2 class="text-2xl font-bold text-gray-900 mb-2">
          æ­£åœ¨å¤„ç†ç™»å½•...
        </h2>
        
        <p class="text-gray-600 mb-6">
          è¯·ç¨å€™ï¼Œæˆ‘ä»¬æ­£åœ¨éªŒè¯æ‚¨çš„èº«ä»½ä¿¡æ¯
        </p>
        
        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div id="status-message" class="text-sm text-gray-500">
          æ­£åœ¨è¿æ¥åˆ°è®¤è¯æœåŠ¡å™¨...
        </div>
        
        <!-- é”™è¯¯æ¶ˆæ¯ -->
        <div id="error-message" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span id="error-text" class="text-red-800"></span>
          </div>
          <div class="mt-3">
            <button
              id="retry-btn"
              class="text-sm bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded transition-colors"
            >
              é‡è¯•
            </button>
            <a
              href="/auth/login"
              class="text-sm text-red-600 hover:text-red-800 ml-3 underline"
            >
              è¿”å›ç™»å½•é¡µ
            </a>
          </div>
        </div>
        
        <!-- æˆåŠŸæ¶ˆæ¯ -->
        <div id="success-message" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-green-800">ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../../lib/supabase';
  import { syncUserToDatabase } from '../../lib/auth';

  // è·å–DOMå…ƒç´ 
  const statusMessage = document.getElementById('status-message');
  const errorMessage = document.getElementById('error-message');
  const errorText = document.getElementById('error-text');
  const successMessage = document.getElementById('success-message');
  const retryBtn = document.getElementById('retry-btn');

  // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
  function updateStatus(message: string) {
    if (statusMessage) {
      statusMessage.textContent = message;
    }
  }

  // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
  function showError(message: string) {
    if (errorMessage && errorText) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
    }
    if (statusMessage) {
      statusMessage.classList.add('hidden');
    }
  }

  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  function showSuccess() {
    if (successMessage) {
      successMessage.classList.remove('hidden');
    }
    if (statusMessage) {
      statusMessage.classList.add('hidden');
    }
  }

  // æ£€æŸ¥æ˜¯å¦æœ‰æ”¯ä»˜æ„å›¾
  function hasPaymentIntent() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('payment_intent') === 'true';
  }

  // å¤„ç†æ”¯ä»˜æ„å›¾
  async function handlePaymentIntent() {
    try {
      updateStatus('æ­£åœ¨å¤„ç†æ”¯ä»˜è¯·æ±‚...');
      
      // ä»sessionStorageè·å–æ”¯ä»˜æ•°æ®
      const paymentDataStr = sessionStorage.getItem('payment_data');
      if (!paymentDataStr) {
        throw new Error('æ”¯ä»˜ä¿¡æ¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°é€‰æ‹©å¥—é¤');
      }
      
      const paymentData = JSON.parse(paymentDataStr);
      
      // æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆ30åˆ†é’Ÿï¼‰
      if (Date.now() - paymentData.timestamp > 30 * 60 * 1000) {
        sessionStorage.removeItem('payment_data');
        throw new Error('æ”¯ä»˜ä¿¡æ¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°é€‰æ‹©å¥—é¤');
      }
      
      updateStatus('æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...');
      
      // è·å–ç”¨æˆ·ID
      const authResponse = await fetch('/api/auth/check');
      if (!authResponse.ok) {
        throw new Error('ç”¨æˆ·è®¤è¯å¤±è´¥');
      }
      
      const authData = await authResponse.json();
      if (!authData.authenticated || !authData.user?.id) {
        throw new Error('ç”¨æˆ·æœªç™»å½•');
      }
      
      updateStatus('æ­£åœ¨åˆ›å»ºæ”¯ä»˜ä¼šè¯...');
      
      // åˆ›å»ºæ”¯ä»˜ä¼šè¯
      const checkoutResponse = await fetch('/api/payment/create-checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          plan: paymentData.plan,
          billing_cycle: paymentData.billing_cycle,
          user_id: authData.user.id
        })
      });
      
      if (!checkoutResponse.ok) {
        const errorData = await checkoutResponse.json();
        throw new Error(errorData.error || 'åˆ›å»ºæ”¯ä»˜ä¼šè¯å¤±è´¥');
      }
      
      const checkoutData = await checkoutResponse.json();
      
      if (!checkoutData.url) {
        throw new Error('æœªè·å–åˆ°æ”¯ä»˜é“¾æ¥');
      }
      
      // æ¸…é™¤sessionStorageä¸­çš„æ”¯ä»˜æ•°æ®
      sessionStorage.removeItem('payment_data');
      
      updateStatus('æ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢...');
      
      // è·³è½¬åˆ°Stripeæ”¯ä»˜é¡µé¢
      window.location.href = checkoutData.url;
      
    } catch (error) {
      console.error('å¤„ç†æ”¯ä»˜æ„å›¾å¤±è´¥:', error);
      showError(error instanceof Error ? error.message : 'æ”¯ä»˜å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // å¤„ç†OAuthå›è°ƒ
  async function handleOAuthCallback() {
    try {
      updateStatus('æ­£åœ¨éªŒè¯ç™»å½•çŠ¶æ€...');
      console.log('å¼€å§‹å¤„ç†OAuthå›è°ƒ...');
      console.log('å½“å‰URL:', window.location.href);
      console.log('URLå‚æ•°:', Object.fromEntries(new URLSearchParams(window.location.search)));

      // ç­‰å¾…Supabaseè‡ªåŠ¨å¤„ç†OAuthå›è°ƒ
      // åœ¨PKCEæµç¨‹ä¸­ï¼ŒSupabaseä¼šè‡ªåŠ¨æ£€æµ‹URLä¸­çš„è®¤è¯ä¿¡æ¯å¹¶è®¾ç½®session
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // è·å–å½“å‰session
      console.log('æ­£åœ¨è·å–Supabase session...');
      const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('è·å–ä¼šè¯å¤±è´¥:', sessionError);
        throw new Error(`è®¤è¯å¤±è´¥: ${sessionError.message}`);
      }
      
      console.log('Sessionæ•°æ®:', sessionData);

      const session = sessionData.session;
      const user = session?.user;
      
      if (!session || !user) {
        console.log('ç¬¬ä¸€æ¬¡å°è¯•æœªæ‰¾åˆ°sessionï¼Œç­‰å¾…æ›´é•¿æ—¶é—´...');
        // å†ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè®©Supabaseå®Œæˆsessionè®¾ç½®
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // å†æ¬¡å°è¯•è·å–session
        const { data: retrySessionData, error: retryError } = await supabase.auth.getSession();
        
        if (retryError) {
          console.error('é‡è¯•è·å–ä¼šè¯å¤±è´¥:', retryError);
          throw new Error(`è®¤è¯å¤±è´¥: ${retryError.message}`);
        }
        
        const retrySession = retrySessionData.session;
        const retryUser = retrySession?.user;
        
        if (!retrySession || !retryUser) {
          throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç™»å½•ä¼šè¯ï¼Œè¯·é‡æ–°ç™»å½•');
        }
        
        // ä½¿ç”¨é‡è¯•è·å–çš„session
        console.log('é‡è¯•åæˆåŠŸè·å–session:', retryUser.email);
      } else {
        console.log('æˆåŠŸè·å–session:', user.email);
      }
      
      // è·å–æœ€ç»ˆçš„sessionæ•°æ®
      const { data: finalSessionData } = await supabase.auth.getSession();
      const finalSession = finalSessionData.session;
      const finalUser = finalSession?.user;
      
      if (!finalSession || !finalUser) {
        throw new Error('æ— æ³•è·å–æœ€ç»ˆçš„ç”¨æˆ·ä¿¡æ¯');
      }
      
      console.log('ç”¨æˆ·è®¤è¯æˆåŠŸ:', finalUser.email);

      // åŒæ­¥ç”¨æˆ·æ•°æ®åˆ°æ•°æ®åº“
      updateStatus('æ­£åœ¨åŒæ­¥ç”¨æˆ·æ•°æ®...');
      console.log('å¼€å§‹åŒæ­¥ç”¨æˆ·æ•°æ®:', {
        id: finalUser.id,
        email: finalUser.email,
        provider: finalUser.app_metadata?.provider
      });
      try {
        await syncUserToDatabase(finalUser);
        console.log('ç”¨æˆ·æ•°æ®åŒæ­¥æˆåŠŸ');
      } catch (syncError) {
        console.warn('ç”¨æˆ·æ•°æ®åŒæ­¥å¤±è´¥ï¼Œä½†ç™»å½•æˆåŠŸ:', syncError);
        console.warn('åŒæ­¥é”™è¯¯è¯¦æƒ…:', syncError);
        // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿç»§ç»­ç™»å½•æµç¨‹
      }

      updateStatus('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...');
      showSuccess();

      // æ£€æŸ¥æ˜¯å¦æœ‰æ”¯ä»˜æ„å›¾éœ€è¦å¤„ç†
      if (hasPaymentIntent()) {
        console.log('å‘ç°æ”¯ä»˜æ„å›¾ï¼Œå¤„ç†æ”¯ä»˜æµç¨‹...');
        await handlePaymentIntent();
        return;
      }

      // æ™ºèƒ½é‡å®šå‘é€»è¾‘ï¼šæ ¹æ®ç”¨æˆ·è§’è‰²å†³å®šé‡å®šå‘ç›®æ ‡
      const urlParams = new URLSearchParams(window.location.search);
      let redirectTo = urlParams.get('redirect_to');
      
      console.log('URLå‚æ•°ä¸­çš„redirect_to:', redirectTo);
      
      // å¦‚æœæ²¡æœ‰æŒ‡å®šé‡å®šå‘ç›®æ ‡ï¼Œæ ¹æ®ç”¨æˆ·è§’è‰²æ™ºèƒ½é€‰æ‹©
      if (!redirectTo) {
        console.log('æœªæŒ‡å®šé‡å®šå‘ç›®æ ‡ï¼Œå¼€å§‹è·å–ç”¨æˆ·è§’è‰²...');
        
        try {
          console.log('å¼€å§‹è·å–ç”¨æˆ·è§’è‰²ï¼Œç”¨æˆ·ID:', finalUser.id);
          console.log('ç”¨æˆ·é‚®ç®±:', finalUser.email);
          
          // è·å–ç”¨æˆ·è§’è‰²
          const roleResponse = await fetch(`${window.location.origin}/api/auth/get-user-role`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId: finalUser.id })
          });
          
          console.log('è§’è‰²APIå“åº”çŠ¶æ€:', roleResponse.status);
          
          if (roleResponse.ok) {
            const roleData = await roleResponse.json();
            console.log('ç”¨æˆ·è§’è‰²APIè¿”å›æ•°æ®:', JSON.stringify(roleData, null, 2));
            
            // æ£€æŸ¥è¿”å›çš„è§’è‰²æ•°æ®
            const userRole = roleData.role;
            console.log('è§£æå‡ºçš„ç”¨æˆ·è§’è‰²:', userRole);
            console.log('è§’è‰²æ ‡å¿—:', {
              isAdmin: roleData.isAdmin,
              isPremium: roleData.isPremium,
              isFree: roleData.isFree
            });
            
            // æ ¹æ®è§’è‰²æ™ºèƒ½é‡å®šå‘
            if (userRole === 'admin') {
              redirectTo = '/admin/backlinks';
              console.log('âœ… ç®¡ç†å‘˜ç”¨æˆ·ï¼Œé‡å®šå‘åˆ°ç®¡ç†é¢æ¿');
            } else if (userRole === 'premium') {
              redirectTo = '/premium/dashboard';
              console.log('âœ… é«˜çº§ç”¨æˆ·ï¼Œé‡å®šå‘åˆ°é«˜çº§é¢æ¿');
            } else {
              redirectTo = '/user/dashboard';
              console.log('âœ… æ™®é€šç”¨æˆ·æˆ–æœªçŸ¥è§’è‰²ï¼Œé‡å®šå‘åˆ°ç”¨æˆ·é¢æ¿');
              // æ¸…ç†å¯èƒ½å­˜åœ¨çš„é”™è¯¯ç®¡ç†å‘˜çŠ¶æ€
              localStorage.removeItem('adminLoggedIn');
              localStorage.removeItem('adminUsername');
              localStorage.removeItem('adminLoginTime');
              console.log('ğŸ§¹ å·²æ¸…ç†éç®¡ç†å‘˜ç”¨æˆ·çš„localStorageçŠ¶æ€');
            }
          } else {
            const errorText = await roleResponse.text();
            console.warn('âŒ è·å–ç”¨æˆ·è§’è‰²å¤±è´¥ï¼ŒçŠ¶æ€ç :', roleResponse.status);
            console.warn('âŒ é”™è¯¯å“åº”:', errorText);
            redirectTo = '/user/dashboard'; // é»˜è®¤é‡å®šå‘åˆ°æ™®é€šç”¨æˆ·é¢æ¿
          }
        } catch (roleError) {
          console.error('âŒ è§’è‰²æ£€æŸ¥å¼‚å¸¸:', roleError);
          console.error('âŒ é”™è¯¯è¯¦æƒ…:', roleError.message);
          redirectTo = '/user/dashboard'; // å‡ºé”™æ—¶é»˜è®¤é‡å®šå‘åˆ°æ™®é€šç”¨æˆ·é¢æ¿
        }
      }
      
      console.log('æœ€ç»ˆé‡å®šå‘ç›®æ ‡:', redirectTo);
      console.log('å‡†å¤‡é‡å®šå‘åˆ°:', redirectTo);
      
      // åªæœ‰çœŸæ­£çš„adminè§’è‰²ç”¨æˆ·æ‰è®¾ç½®localStorageçŠ¶æ€
      if (redirectTo === '/admin/backlinks' || redirectTo.startsWith('/admin/')) {
        console.log('è®¾ç½®ç®¡ç†å‘˜localStorageçŠ¶æ€...');
        localStorage.setItem('adminLoggedIn', 'true');
        localStorage.setItem('adminUsername', finalUser.email || 'OAuthç”¨æˆ·');
        localStorage.setItem('adminLoginTime', new Date().toISOString());
        console.log('ç®¡ç†å‘˜localStorageçŠ¶æ€å·²è®¾ç½®:', {
          adminLoggedIn: localStorage.getItem('adminLoggedIn'),
          adminUsername: localStorage.getItem('adminUsername'),
          adminLoginTime: localStorage.getItem('adminLoginTime')
        });
      } else {
        // éç®¡ç†å‘˜ç”¨æˆ·ï¼Œæ¸…ç†å¯èƒ½å­˜åœ¨çš„ç®¡ç†å‘˜çŠ¶æ€
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('adminUsername');
        localStorage.removeItem('adminLoginTime');
        console.log('ğŸ§¹ å·²æ¸…ç†éç®¡ç†å‘˜ç”¨æˆ·çš„localStorageçŠ¶æ€');
      }
      
      // è·³è½¬åˆ°ç›®æ ‡é¡µé¢
      console.log('å³å°†è·³è½¬åˆ°:', redirectTo);
      setTimeout(() => {
        console.log('æ‰§è¡Œè·³è½¬åˆ°:', redirectTo);
        window.location.href = redirectTo;
      }, 500);

    } catch (error) {
      console.error('OAuthå›è°ƒå¤„ç†å¤±è´¥:', error);
      console.error('é”™è¯¯å †æ ˆ:', error instanceof Error ? error.stack : error);
      console.error('å½“å‰URLçŠ¶æ€:', {
        href: window.location.href,
        search: window.location.search,
        hash: window.location.hash
      });
      showError(error instanceof Error ? error.message : 'ç™»å½•å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // é‡è¯•æŒ‰é’®äº‹ä»¶
  if (retryBtn) {
    retryBtn.addEventListener('click', () => {
      // éšè—é”™è¯¯æ¶ˆæ¯
      if (errorMessage) {
        errorMessage.classList.add('hidden');
      }
      if (statusMessage) {
        statusMessage.classList.remove('hidden');
      }
      
      // é‡æ–°å¤„ç†å›è°ƒ
      handleOAuthCallback();
    });
  }

  // é¡µé¢åŠ è½½æ—¶å¤„ç†OAuthå›è°ƒ
  document.addEventListener('DOMContentLoaded', () => {
    console.log('=== OAuthå›è°ƒé¡µé¢åŠ è½½ ===');
    console.log('å®Œæ•´URL:', window.location.href);
    
    // æ£€æŸ¥URLä¸­æ˜¯å¦åŒ…å«è®¤è¯ç›¸å…³å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    
    // æ£€æŸ¥æ˜¯å¦æœ‰OAuthç›¸å…³å‚æ•°ï¼ˆcodeç”¨äºPKCEæµç¨‹ï¼Œerrorç”¨äºé”™è¯¯å¤„ç†ï¼‰
    const hasAuthParams = urlParams.has('code') || urlParams.has('error') || hashParams.has('error');
    
    console.log('æ£€æŸ¥è®¤è¯å‚æ•°:', {
      search: Object.fromEntries(urlParams),
      fragment: Object.fromEntries(hashParams),
      hasAuthParams,
      userAgent: navigator.userAgent
    });
    
    if (hasAuthParams) {
      console.log('å‘ç°OAuthå‚æ•°ï¼Œå¼€å§‹å¤„ç†å›è°ƒ...');
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å‚æ•°
      const error = urlParams.get('error') || hashParams.get('error');
      const errorDescription = urlParams.get('error_description') || hashParams.get('error_description');
      
      if (error) {
        console.error('OAuthé”™è¯¯:', error, errorDescription);
        console.error('å®Œæ•´é”™è¯¯ä¿¡æ¯:', {
          error,
          errorDescription,
          url: window.location.href
        });
        showError(`ç™»å½•å¤±è´¥: ${errorDescription || error}`);
        return;
      }
      
      // å¤„ç†OAuthå›è°ƒ
      handleOAuthCallback();
    } else {
      console.log('æœªå‘ç°OAuthå‚æ•°ï¼Œæ£€æŸ¥ç°æœ‰session...');
      // å¦‚æœæ²¡æœ‰OAuthå‚æ•°ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•
      supabase.auth.getSession().then(async ({ data: { session } }) => {
        if (session) {
          console.log('å‘ç°ç°æœ‰sessionï¼Œå¼€å§‹æ™ºèƒ½é‡å®šå‘...');
          showSuccess();
          
          // æ™ºèƒ½é‡å®šå‘é€»è¾‘ï¼šæ ¹æ®ç”¨æˆ·è§’è‰²å†³å®šé‡å®šå‘ç›®æ ‡
          let redirectTo = urlParams.get('redirect_to');
          
          // å¦‚æœæ²¡æœ‰æŒ‡å®šé‡å®šå‘ç›®æ ‡ï¼Œæ ¹æ®ç”¨æˆ·è§’è‰²æ™ºèƒ½é€‰æ‹©
          if (!redirectTo) {
            console.log('ç°æœ‰sessionæœªæŒ‡å®šé‡å®šå‘ç›®æ ‡ï¼Œå¼€å§‹è·å–ç”¨æˆ·è§’è‰²...');
            
            try {
              console.log('ç°æœ‰sessionå¼€å§‹è·å–ç”¨æˆ·è§’è‰²ï¼Œç”¨æˆ·ID:', session.user.id);
              console.log('ç°æœ‰sessionç”¨æˆ·é‚®ç®±:', session.user.email);
              
              // è·å–ç”¨æˆ·è§’è‰²
              const roleResponse = await fetch(`${window.location.origin}/api/auth/get-user-role`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ userId: session.user.id })
              });
              
              console.log('ç°æœ‰sessionè§’è‰²APIå“åº”çŠ¶æ€:', roleResponse.status);
              
              if (roleResponse.ok) {
                const roleData = await roleResponse.json();
                console.log('ç°æœ‰sessionç”¨æˆ·è§’è‰²APIè¿”å›æ•°æ®:', JSON.stringify(roleData, null, 2));
                
                // æ£€æŸ¥è¿”å›çš„è§’è‰²æ•°æ®
                const userRole = roleData.role;
                console.log('ç°æœ‰sessionè§£æå‡ºçš„ç”¨æˆ·è§’è‰²:', userRole);
                console.log('ç°æœ‰sessionè§’è‰²æ ‡å¿—:', {
                  isAdmin: roleData.isAdmin,
                  isPremium: roleData.isPremium,
                  isFree: roleData.isFree
                });
                
                // æ ¹æ®è§’è‰²æ™ºèƒ½é‡å®šå‘
                if (userRole === 'admin') {
                  redirectTo = '/admin/backlinks';
                  console.log('âœ… ç°æœ‰sessionç®¡ç†å‘˜ç”¨æˆ·ï¼Œé‡å®šå‘åˆ°ç®¡ç†é¢æ¿');
                } else if (userRole === 'premium') {
                  redirectTo = '/premium/dashboard';
                  console.log('âœ… ç°æœ‰sessioné«˜çº§ç”¨æˆ·ï¼Œé‡å®šå‘åˆ°é«˜çº§é¢æ¿');
                } else {
                  redirectTo = '/user/dashboard';
                  console.log('âœ… ç°æœ‰sessionæ™®é€šç”¨æˆ·æˆ–æœªçŸ¥è§’è‰²ï¼Œé‡å®šå‘åˆ°ç”¨æˆ·é¢æ¿');
                  // æ¸…ç†å¯èƒ½å­˜åœ¨çš„é”™è¯¯ç®¡ç†å‘˜çŠ¶æ€
                  localStorage.removeItem('adminLoggedIn');
                  localStorage.removeItem('adminUsername');
                  localStorage.removeItem('adminLoginTime');
                  console.log('ğŸ§¹ ç°æœ‰sessionå·²æ¸…ç†éç®¡ç†å‘˜ç”¨æˆ·çš„localStorageçŠ¶æ€');
                }
              } else {
                const errorText = await roleResponse.text();
                console.warn('âŒ ç°æœ‰sessionè·å–ç”¨æˆ·è§’è‰²å¤±è´¥ï¼ŒçŠ¶æ€ç :', roleResponse.status);
                console.warn('âŒ ç°æœ‰sessioné”™è¯¯å“åº”:', errorText);
                redirectTo = '/user/dashboard'; // é»˜è®¤é‡å®šå‘åˆ°æ™®é€šç”¨æˆ·é¢æ¿
              }
            } catch (roleError) {
              console.error('âŒ ç°æœ‰sessionè§’è‰²æ£€æŸ¥å¼‚å¸¸:', roleError);
              console.error('âŒ ç°æœ‰sessioné”™è¯¯è¯¦æƒ…:', roleError.message);
              redirectTo = '/user/dashboard'; // å‡ºé”™æ—¶é»˜è®¤é‡å®šå‘åˆ°æ™®é€šç”¨æˆ·é¢æ¿
            }
          }
          
          setTimeout(() => {
            console.log('ç°æœ‰sessionè·³è½¬åˆ°:', redirectTo);
            
            // åªæœ‰çœŸæ­£çš„adminè§’è‰²ç”¨æˆ·æ‰è®¾ç½®localStorageçŠ¶æ€
            if (redirectTo === '/admin/backlinks' || redirectTo.startsWith('/admin/')) {
              console.log('ä¸ºç°æœ‰sessionè®¾ç½®ç®¡ç†å‘˜localStorageçŠ¶æ€...');
              localStorage.setItem('adminLoggedIn', 'true');
              localStorage.setItem('adminUsername', session.user?.email || 'OAuthç”¨æˆ·');
              localStorage.setItem('adminLoginTime', new Date().toISOString());
              console.log('ç°æœ‰sessionç®¡ç†å‘˜localStorageçŠ¶æ€å·²è®¾ç½®');
            } else {
              // éç®¡ç†å‘˜ç”¨æˆ·ï¼Œæ¸…ç†å¯èƒ½å­˜åœ¨çš„ç®¡ç†å‘˜çŠ¶æ€
              localStorage.removeItem('adminLoggedIn');
              localStorage.removeItem('adminUsername');
              localStorage.removeItem('adminLoginTime');
              console.log('ğŸ§¹ ç°æœ‰sessionå·²æ¸…ç†éç®¡ç†å‘˜ç”¨æˆ·çš„localStorageçŠ¶æ€');
            }
            
            window.location.href = redirectTo;
          }, 500);
        } else {
          console.log('æœªæ‰¾åˆ°ç°æœ‰session');
          showError('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
        }
      });
    }
  });
</script>