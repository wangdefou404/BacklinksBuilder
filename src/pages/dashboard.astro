---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/global/Navigation.astro';
import Footer from '../components/global/Footer.astro';

// è·å–ç”¨æˆ·ä¼šè¯ä¿¡æ¯
const session = Astro.locals.session;
const user = Astro.locals.user;

console.log('ğŸ” Dashboard - session:', session ? 'exists' : 'null');
console.log('ğŸ” Dashboard - user:', user ? 'exists' : 'null');
if (user) {
  console.log('ğŸ” Dashboard - user details:', { id: user.id, email: user.email, role: user.role });
}

// å¦‚æœæœåŠ¡ç«¯æ£€æµ‹åˆ°ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºåŠ è½½é¡µé¢è®©å®¢æˆ·ç«¯å¤„ç†
let serverSideAuth = false;
let userRole = 'free';
let userId = null;
let userEmail = null;

if (session && user) {
  serverSideAuth = true;
  userId = user.id;
  userEmail = user.email;
  
  // ä»ä¸­é—´ä»¶è®¾ç½®çš„userå¯¹è±¡ä¸­è·å–è§’è‰²ä¿¡æ¯
  if (user.role) {
    userRole = user.role;
  }
  
  console.log('æœåŠ¡ç«¯æ£€æµ‹åˆ°ç”¨æˆ·:', userEmail, 'è§’è‰²:', userRole);
  
  // æ ¹æ®ç”¨æˆ·è§’è‰²é‡å®šå‘åˆ°ç›¸åº”çš„dashboardé¡µé¢
  console.log('ğŸš€ Redirecting user with role:', userRole);
  switch (userRole) {
    case 'admin':
      console.log('ğŸ”‘ Admin user, redirecting to admin dashboard');
      return Astro.redirect('/admin/dashboard');
    case 'super':
      console.log('â­ Super user, redirecting to super dashboard');
      return Astro.redirect('/super/dashboard');
    case 'Pro':
      console.log('ğŸ’ Pro user, redirecting to premium dashboard');
      return Astro.redirect('/premium/dashboard');
    case 'super':
      console.log('ğŸš€ Super user, redirecting to admin dashboard');
      return Astro.redirect('/admin/dashboard');
    case 'user':
    case 'free':
    default:
      console.log('ğŸ‘¤ Regular/Free user, redirecting to user dashboard');
      // é»˜è®¤è·³è½¬åˆ°æ™®é€šç”¨æˆ·é¢æ¿
      return Astro.redirect('/user/dashboard');
  }
}
---

<BaseLayout title="Dashboard - Loading...">
  <Navigation />
  
  <main class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Loading your dashboard...</h1>
        <p class="text-gray-600">Please wait while we prepare your personalized dashboard experience.</p>
        
        <!-- Alternative navigation links -->
        <div class="mt-8 space-y-4">
          <p class="text-sm text-gray-500">Or visit directly:</p>
          <div class="flex flex-wrap justify-center gap-4">
            <a href="/dr-checker" class="text-blue-600 hover:text-blue-800 underline">DR Checker</a>
            <a href="/traffic-checker" class="text-blue-600 hover:text-blue-800 underline">Traffic Checker</a>
            <a href="/backlink-generator" class="text-blue-600 hover:text-blue-800 underline">Backlink Generator</a>
            <a href="/pricing" class="text-blue-600 hover:text-blue-800 underline">Pricing Plans</a>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <Footer />
</BaseLayout>

<style>
  .transition-colors {
    transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
  }
  
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  
  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>

<script>
  import { getCurrentUser, getCurrentSession } from '../lib/auth';
  
  // å®¢æˆ·ç«¯è®¤è¯é€»è¾‘
  async function handleClientAuth() {
    try {
      console.log('å¼€å§‹å®¢æˆ·ç«¯è®¤è¯æ£€æŸ¥...');
      
      // è·å–å½“å‰ç”¨æˆ·å’Œä¼šè¯
      const [user, session] = await Promise.all([
        getCurrentUser(),
        getCurrentSession()
      ]);
      
      console.log('ç”¨æˆ·ä¿¡æ¯:', user);
      console.log('ä¼šè¯ä¿¡æ¯:', session);
      
      // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
      if (!user || !session) {
        console.log('ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
        window.location.href = '/login?redirect=/dashboard';
        return;
      }
      
      // è·å–ç”¨æˆ·è§’è‰²
      try {
        const response = await fetch(`/api/auth/get-user-role?userId=${user.id}`);
        if (response.ok) {
          const data = await response.json();
          const userRole = data.role || 'free';
          
          console.log('ç”¨æˆ·è§’è‰²:', userRole);
          
          // æ ¹æ®ç”¨æˆ·è§’è‰²é‡å®šå‘åˆ°ç›¸åº”çš„dashboardé¡µé¢
          console.log('ğŸš€ Client-side redirecting user with role:', userRole);
          switch (userRole) {
            case 'admin':
              console.log('ğŸ”‘ Admin user, redirecting to admin dashboard');
              window.location.href = '/admin/dashboard';
              break;
            case 'super':
              console.log('â­ Super user, redirecting to super dashboard');
              window.location.href = '/super/dashboard';
              break;
            case 'Pro':
        console.log('ğŸ’ Pro user, redirecting to premium dashboard');
        window.location.href = '/premium/dashboard';
        break;
      case 'super':
        console.log('ğŸš€ Super user, redirecting to admin dashboard');
        window.location.href = '/admin/dashboard';
              break;
            case 'user':
            case 'free':
            default:
              console.log('ğŸ‘¤ Regular/Free user, redirecting to user dashboard');
              // é»˜è®¤è·³è½¬åˆ°æ™®é€šç”¨æˆ·é¢æ¿
              window.location.href = '/user/dashboard';
              break;
          }
        } else {
          console.error('è·å–ç”¨æˆ·è§’è‰²å¤±è´¥ï¼Œé»˜è®¤è·³è½¬åˆ°ç”¨æˆ·dashboard');
          window.location.href = '/user/dashboard';
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·è§’è‰²æ—¶å‡ºé”™:', error);
        window.location.href = '/user/dashboard';
      }
      
    } catch (error) {
      console.error('å®¢æˆ·ç«¯è®¤è¯å¤±è´¥:', error);
      // å¦‚æœè®¤è¯å¤±è´¥ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
      window.location.href = '/login?redirect=/dashboard';
    }
  }
  
  // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œè®¤è¯æ£€æŸ¥
  document.addEventListener('DOMContentLoaded', () => {
    handleClientAuth();
  });
  
  // å¤‡ç”¨è¶…æ—¶é‡å®šå‘ï¼ˆ10ç§’åï¼‰
  setTimeout(() => {
    console.log('è¶…æ—¶é‡å®šå‘åˆ°ç”¨æˆ·dashboard');
    window.location.href = '/user/dashboard';
  }, 10000);
</script>