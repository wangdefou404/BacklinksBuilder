---
// 调试用户角色的测试页面
import BaseLayout from '../layouts/BaseLayout.astro';

// 获取用户会话信息
const session = Astro.locals.session;
const user = Astro.locals.user;

let debugInfo = {
  hasSession: !!session,
  hasUser: !!user,
  userId: user?.id || 'N/A',
  userEmail: user?.email || 'N/A',
  userRole: user?.role || 'N/A',
  sessionData: session ? JSON.stringify(session, null, 2) : 'No session',
  userData: user ? JSON.stringify(user, null, 2) : 'No user',
  roleApiResult: null,
  roleApiError: null
};

// 如果有用户ID，尝试调用角色API
if (user?.id) {
  try {
    const response = await fetch(`${Astro.url.origin}/api/auth/get-user-role`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ userId: user.id })
    });

    if (response.ok) {
      debugInfo.roleApiResult = await response.json();
    } else {
      const error = await response.json();
      debugInfo.roleApiError = error;
    }
  } catch (error) {
    debugInfo.roleApiError = {
      message: error.message,
      stack: error.stack
    };
  }
}
---

<BaseLayout title="角色调试页面">
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white shadow-lg rounded-lg p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">用户角色调试信息</h1>
        
        <!-- 基本会话信息 -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">基本信息</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">有会话</label>
              <p class={`text-sm ${debugInfo.hasSession ? 'text-green-600' : 'text-red-600'}`}>
                {debugInfo.hasSession ? '是' : '否'}
              </p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">有用户</label>
              <p class={`text-sm ${debugInfo.hasUser ? 'text-green-600' : 'text-red-600'}`}>
                {debugInfo.hasUser ? '是' : '否'}
              </p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">用户ID</label>
              <p class="text-sm text-gray-900 font-mono">{debugInfo.userId}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">用户邮箱</label>
              <p class="text-sm text-gray-900">{debugInfo.userEmail}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">中间件角色</label>
              <p class="text-sm text-gray-900">{debugInfo.userRole}</p>
            </div>
          </div>
        </div>

        <!-- API调用结果 -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">角色API调用结果</h2>
          {debugInfo.roleApiResult ? (
            <div class="bg-green-50 border border-green-200 rounded p-4">
              <h3 class="text-sm font-medium text-green-800 mb-2">成功响应</h3>
              <pre class="text-xs text-green-700 overflow-auto">{JSON.stringify(debugInfo.roleApiResult, null, 2)}</pre>
            </div>
          ) : debugInfo.roleApiError ? (
            <div class="bg-red-50 border border-red-200 rounded p-4">
              <h3 class="text-sm font-medium text-red-800 mb-2">错误响应</h3>
              <pre class="text-xs text-red-700 overflow-auto">{JSON.stringify(debugInfo.roleApiError, null, 2)}</pre>
            </div>
          ) : (
            <div class="bg-gray-50 border border-gray-200 rounded p-4">
              <p class="text-sm text-gray-600">未调用API（用户未登录）</p>
            </div>
          )}
        </div>

        <!-- 详细会话数据 -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">会话数据</h2>
          <div class="bg-gray-50 border border-gray-200 rounded p-4">
            <pre class="text-xs text-gray-700 overflow-auto">{debugInfo.sessionData}</pre>
          </div>
        </div>

        <!-- 详细用户数据 -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">用户数据</h2>
          <div class="bg-gray-50 border border-gray-200 rounded p-4">
            <pre class="text-xs text-gray-700 overflow-auto">{debugInfo.userData}</pre>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="flex space-x-4">
          <a href="/dashboard" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            返回Dashboard
          </a>
          <button onclick="window.location.reload()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            刷新页面
          </button>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  // 客户端调试
  console.log('🔍 Debug page loaded');
  console.log('📊 Debug info:', {
    hasSession: document.querySelector('[data-has-session]')?.textContent,
    hasUser: document.querySelector('[data-has-user]')?.textContent,
    userId: document.querySelector('[data-user-id]')?.textContent,
    userEmail: document.querySelector('[data-user-email]')?.textContent
  });
</script>