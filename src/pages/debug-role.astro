---
// è°ƒè¯•ç”¨æˆ·è§’è‰²çš„æµ‹è¯•é¡µé¢
import BaseLayout from '../layouts/BaseLayout.astro';

// è·å–ç”¨æˆ·ä¼šè¯ä¿¡æ¯
const session = Astro.locals.session;
const user = Astro.locals.user;

let debugInfo = {
  hasSession: !!session,
  hasUser: !!user,
  userId: user?.id || 'N/A',
  userEmail: user?.email || 'N/A',
  userRole: user?.role || 'N/A',
  sessionData: session ? JSON.stringify(session, null, 2) : 'No session',
  userData: user ? JSON.stringify(user, null, 2) : 'No user',
  roleApiResult: null,
  roleApiError: null
};

// å¦‚æœæœ‰ç”¨æˆ·IDï¼Œå°è¯•è°ƒç”¨è§’è‰²API
if (user?.id) {
  try {
    const response = await fetch(`${Astro.url.origin}/api/auth/get-user-role`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ userId: user.id })
    });

    if (response.ok) {
      debugInfo.roleApiResult = await response.json();
    } else {
      const error = await response.json();
      debugInfo.roleApiError = error;
    }
  } catch (error) {
    debugInfo.roleApiError = {
      message: error.message,
      stack: error.stack
    };
  }
}
---

<BaseLayout title="è§’è‰²è°ƒè¯•é¡µé¢">
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white shadow-lg rounded-lg p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">ç”¨æˆ·è§’è‰²è°ƒè¯•ä¿¡æ¯</h1>
        
        <!-- åŸºæœ¬ä¼šè¯ä¿¡æ¯ -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">åŸºæœ¬ä¿¡æ¯</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">æœ‰ä¼šè¯</label>
              <p class={`text-sm ${debugInfo.hasSession ? 'text-green-600' : 'text-red-600'}`}>
                {debugInfo.hasSession ? 'æ˜¯' : 'å¦'}
              </p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">æœ‰ç”¨æˆ·</label>
              <p class={`text-sm ${debugInfo.hasUser ? 'text-green-600' : 'text-red-600'}`}>
                {debugInfo.hasUser ? 'æ˜¯' : 'å¦'}
              </p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">ç”¨æˆ·ID</label>
              <p class="text-sm text-gray-900 font-mono">{debugInfo.userId}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">ç”¨æˆ·é‚®ç®±</label>
              <p class="text-sm text-gray-900">{debugInfo.userEmail}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded">
              <label class="block text-sm font-medium text-gray-700">ä¸­é—´ä»¶è§’è‰²</label>
              <p class="text-sm text-gray-900">{debugInfo.userRole}</p>
            </div>
          </div>
        </div>

        <!-- APIè°ƒç”¨ç»“æœ -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">è§’è‰²APIè°ƒç”¨ç»“æœ</h2>
          {debugInfo.roleApiResult ? (
            <div class="bg-green-50 border border-green-200 rounded p-4">
              <h3 class="text-sm font-medium text-green-800 mb-2">æˆåŠŸå“åº”</h3>
              <pre class="text-xs text-green-700 overflow-auto">{JSON.stringify(debugInfo.roleApiResult, null, 2)}</pre>
            </div>
          ) : debugInfo.roleApiError ? (
            <div class="bg-red-50 border border-red-200 rounded p-4">
              <h3 class="text-sm font-medium text-red-800 mb-2">é”™è¯¯å“åº”</h3>
              <pre class="text-xs text-red-700 overflow-auto">{JSON.stringify(debugInfo.roleApiError, null, 2)}</pre>
            </div>
          ) : (
            <div class="bg-gray-50 border border-gray-200 rounded p-4">
              <p class="text-sm text-gray-600">æœªè°ƒç”¨APIï¼ˆç”¨æˆ·æœªç™»å½•ï¼‰</p>
            </div>
          )}
        </div>

        <!-- è¯¦ç»†ä¼šè¯æ•°æ® -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">ä¼šè¯æ•°æ®</h2>
          <div class="bg-gray-50 border border-gray-200 rounded p-4">
            <pre class="text-xs text-gray-700 overflow-auto">{debugInfo.sessionData}</pre>
          </div>
        </div>

        <!-- è¯¦ç»†ç”¨æˆ·æ•°æ® -->
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">ç”¨æˆ·æ•°æ®</h2>
          <div class="bg-gray-50 border border-gray-200 rounded p-4">
            <pre class="text-xs text-gray-700 overflow-auto">{debugInfo.userData}</pre>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex space-x-4">
          <a href="/dashboard" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            è¿”å›Dashboard
          </a>
          <button onclick="window.location.reload()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            åˆ·æ–°é¡µé¢
          </button>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  // å®¢æˆ·ç«¯è°ƒè¯•
  console.log('ğŸ” Debug page loaded');
  console.log('ğŸ“Š Debug info:', {
    hasSession: document.querySelector('[data-has-session]')?.textContent,
    hasUser: document.querySelector('[data-has-user]')?.textContent,
    userId: document.querySelector('[data-user-id]')?.textContent,
    userEmail: document.querySelector('[data-user-email]')?.textContent
  });
</script>